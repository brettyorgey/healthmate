<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FifthQtr Healthmate</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Optional: Cloudflare Turnstile (captcha) if enabled in your API) -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

  <style>
    :root { --card-bg:#ffffff; --page-bg:#f7f9fc; --text:#0f172a; --muted:#4b5563; --brand:#0ea5e9; }
    body { margin:0; background:var(--page-bg); color:var(--text); font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    .wrap { width:70%; max-width:1000px; min-width:320px; margin:24px auto; padding:0 16px; }

    .hero { background:var(--card-bg); border-radius:16px; padding:24px; box-shadow:0 4px 14px rgba(15,23,42,0.08); margin-bottom:12px; }
    .hero h1{ margin:0 0 8px; font-size:28px; line-height:1.2;}
    .hero p{ margin:6px 0 0; color:var(--muted);}

    .toolbar{ display:flex; gap:8px; justify-content:flex-end; margin-bottom:10px; }
    .btn-sm{ padding:8px 10px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; font-size:13px; }
    .btn-sm:hover{ background:#f9fafb; }

    /* Category list */
    .categories { display:flex; flex-direction:column; gap:10px; margin:16px 0; }
    .category-card{
      display:flex; gap:12px; align-items:center; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:14px 16px; cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.05);
    }
    .category-card:hover{ background:#f9fafb; }
    .category-emoji{ font-size:22px; }
    .category-title{ font-weight:700; }
    .category-sub{ color:#64748b; font-size:14px; }

    /* Prompt + chat panel */
    .prompt-panel{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:14px 16px; box-shadow:0 2px 6px rgba(0,0,0,.05); }
    .prompt-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .back-link{ color:var(--brand); text-decoration:underline; cursor:pointer; font-size:14px; }
    .prompts{ display:flex; flex-direction:column; gap:10px; margin-top:8px; }
    .prompt-btn{ text-align:left; border:1px solid #e5e7eb; background:#fff; border-radius:10px; padding:10px 12px; cursor:pointer; font-size:15px; }
    .prompt-btn:hover{ background:#f9fafb; }

    /* Category badge */
    .cat-tag{
      display:inline-flex; align-items:center; gap:8px;
      margin-top:6px; margin-bottom:6px;
      background:#e0f2fe; color:#075985; border:1px solid #bae6fd;
      padding:6px 10px; border-radius:999px; font-size:13px; font-weight:600;
    }
    .cat-tag .dot{ display:inline-block; width:6px; height:6px; border-radius:50%; background:#0ea5e9; }
    .cat-tag a{ color:#0369a1; text-decoration:underline; font-weight:600; margin-left:6px; }
    .cat-tag a:hover{ text-decoration:none; }

    /* Chat area embedded under prompts */
    .chat{ background:#fff; border-radius:12px; padding:12px; border:1px dashed #e5e7eb; margin-top:14px; display:flex; flex-direction:column; gap:10px; }
    .msg{ max-width:80%; white-space:pre-wrap; }
    .msg.user{ align-self:flex-end; background:#dbeafe; color:#0f172a; padding:10px 12px; border-radius:12px 12px 0 12px; text-align:right; }
    .msg.assistant{ align-self:flex-start; background:#f8fafc; color:#0f172a; padding:10px 12px; border-radius:12px 12px 12px 0; }
    .msg.assistant h2,.msg.assistant h3{ margin:10px 0 6px; font-size:18px; line-height:1.25; border-left:4px solid var(--brand); padding-left:8px; }

    /* Sources (legacy) */
    .sources{ margin-top:12px; padding:10px; border:1px solid #e5e7eb; border-radius:10px; background:#f9fafb; font-size:14px; line-height:1.5; }
    .sources strong{ display:block; margin-bottom:6px; font-size:15px; color:var(--text); }
    .sources ul{ margin:0; padding-left:18px; }
    .sources li{ margin-bottom:4px; }
    .sources a{ color:#0ea5e9; font-weight:500; text-decoration:underline; }
    .sources a:hover{ text-decoration:none; }
    .src-quote{ margin-top:4px; padding-left:10px; border-left:3px solid #e5e7eb; color:#475569; font-size:13px; font-style:italic; line-height:1.5; white-space:pre-wrap; }

    /* Input row with mic */
    .inputRow{ display:flex; gap:10px; align-items:stretch; margin-top:6px;}
    textarea#msg{ flex:1; padding:14px 16px; font-size:16px; line-height:1.35; border-radius:12px; border:1px solid #e5e7eb; resize:vertical; min-height:72px; max-height:300px; }
    button.send{ padding:14px 18px; border-radius:12px; border:0; background:var(--brand); color:#fff; cursor:pointer; font-size:16px; font-weight:600; }
    button.send[disabled]{ opacity:.6; cursor:not-allowed; }
    .btn-icon{ padding:0 14px; border-radius:12px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; font-size:18px; display:flex; align-items:center; justify-content:center; min-width:56px; }
    .btn-icon:hover{ background:#f9fafb; }
    .mic-recording{ color:#dc2626; border-color:#fecaca; background:#fff5f5; }
    .mic-dot{ display:inline-block; width:8px; height:8px; border-radius:50%; background:#ef4444; margin-left:6px; animation:pulse 1s infinite; }
    @keyframes pulse{ 0%{ transform:scale(.85); opacity:.7;} 50%{ transform:scale(1); opacity:1;} 100%{ transform:scale(.85); opacity:.7;} }

    /* Thinking‚Ä¶ */
    .thinking{ display:inline-flex; gap:6px; align-items:center; color:#475569; }
    .dot{ width:6px; height:6px; border-radius:50%; background:#94a3b8; opacity:.6; animation:b 1.3s infinite ease-in-out; }
    .dot:nth-child(2){ animation-delay:.15s; } .dot:nth-child(3){ animation-delay:.3s; }
    @keyframes b { 0%,80%,100%{ transform:scale(0.7); opacity:.4; } 40%{ transform:scale(1); opacity:1; } }

    /* QUICK ‚Üí EXPAND card styles */
    .fq-card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 2px 8px rgba(15,23,42,.06);padding:16px;margin:12px 0;color:#0f172a}
    .fq-topline{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .fq-topline .pill{background:#e0f2fe;color:#075985;border:1px solid #bae6fd;font-weight:700;border-radius:999px;font-size:12px;padding:4px 10px}
    .fq-h2{margin:4px 0 10px;font-size:18px;line-height:1.25;border-left:4px solid #0ea5e9;padding-left:8px;font-weight:800}
    .fq-quick{background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:10px;margin:8px 0}
    .fq-quick ul{margin:6px 0 0 18px}
    .fq-quick li{margin:6px 0}
    .fq-disclaimer{color:#475569;font-size:13px;margin-top:6px}
    .fq-cta{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .fq-btn{border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer;font-size:14px}
    .fq-btn:hover{background:#f3f4f6}
    details.fq-exp{border:1px solid #e5e7eb;border-radius:10px;background:#fff;margin-top:10px}
    details.fq-exp>summary{list-style:none;cursor:pointer;padding:10px 12px;font-weight:700}
    details.fq-exp>summary::-webkit-details-marker{display:none}
    details.fq-exp[open]{box-shadow:0 1px 6px rgba(0,0,0,.04)}
    .fq-exp-body{padding:0 12px 12px}
    .fq-exp-body ul{margin:6px 0 0 18px}
    .fq-kv{display:grid;grid-template-columns:1fr;gap:8px}
    .fq-red{background:#fff5f5;border-left:4px solid #ef4444;padding:10px;border-radius:8px;margin-top:10px}
    .fq-red strong{color:#b91c1c}
    .fq-sources{background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:10px;margin-top:10px;font-size:14px}
    .fq-sources ul{margin:6px 0 0 18px}
    .fq-sources a{color:#0ea5e9;text-decoration:underline}
    @media (min-width: 720px){ .fq-kv{grid-template-columns:1fr 1fr} }

    /* Visibility */
    #categoryView, #promptView { display:none; }
    #categoryView.active, #promptView.active { display:block; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>Welcome ‚Äî we‚Äôre here to support past players & families.</h1>
      <p>Information only ‚Äî not a medical diagnosis. Please see your GP for advice. In an emergency call 000.</p>
    </div>

    <div class="toolbar">
      <button class="btn-sm" id="copyBtn" title="Copy conversation to clipboard">Copy conversation</button>
      <button class="btn-sm" id="resetBtn" title="Clear chat">Reset chat</button>
    </div>

    <!-- Step 1: Categories -->
    <div id="categoryView" class="categories active" aria-live="polite"></div>

    <!-- Step 2: Sub-prompts + embedded chat -->
    <div id="promptView" class="prompt-panel" aria-live="polite">
      <div class="prompt-header">
        <div id="promptTitle" class="category-title"></div>
        <div class="back-link" onclick="showCategories()">‚Üê Back to Categories</div>
      </div>

      <!-- Category badge -->
      <div id="activeCategory" class="cat-tag" style="display:none;">
        <span class="dot" aria-hidden="true"></span>
        <span id="activeCategoryText">You‚Äôre asking about: ‚Ä¶</span>
        <a href="javascript:void(0)" onclick="showCategories()" aria-label="Change category">Change category</a>
      </div>

      <div id="promptList" class="prompts"></div>

      <!-- Chat lives here (under the prompts) -->
      <div class="chat" id="chat" aria-live="polite"></div>
      <div class="inputRow">
        <button class="btn-icon" id="micBtn" title="Speak your question">üé§</button>
        <textarea id="msg" rows="3" placeholder="Type your question‚Ä¶"></textarea>
        <button class="send" id="sendBtn" onclick="sendMsg()">Send</button>
      </div>

      <!-- Optional Turnstile captcha (remove if not used) -->
      <div class="cf-turnstile" data-sitekey="YOUR_TURNSTILE_SITE_KEY" data-callback="onCaptcha"></div>
    </div>
  </div>

  <script>
    // ----- Optional captcha token -----
    let captchaToken = '';
    function onCaptcha(token){ captchaToken = token; }

    // ----- Data & views -----
    let PROMPTS = {};
    const categoryView = document.getElementById('categoryView');
    const promptView   = document.getElementById('promptView');
    const promptTitle  = document.getElementById('promptTitle');
    const promptList   = document.getElementById('promptList');

    // Badge elements
    const activeCategoryEl = document.getElementById('activeCategory');
    const activeCategoryTextEl = document.getElementById('activeCategoryText');

    const EMOJI = {
      "Psychological": "üß†", "Physical": "üèãÔ∏è", "Career": "üíº", "Family": "üë®‚Äçüë©‚Äçüëß‚Äçüë¶",
      "Cultural": "üåè", "Identity": "üé≠", "Financial": "üí∞", "Environmental": "‚ö†Ô∏è", "Female": "‚ôÄÔ∏è"
    };

    // ----- Transcript & helpers -----
    const TRANSCRIPT = []; // {role,text}

    function mdToHtml(md){
      if(!md) return '';
      let s=md;
      s=s.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>');
      s=s.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>');
      s=s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
      s=s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
      s=s.replace(/\n{2,}/g,'</p><p>').replace(/\n/g,'<br/>');
      return '<p>'+s+'</p>';
    }
    function trimQuote(q,max=280){ if(!q) return ''; const t=q.trim(); return t.length>max?t.slice(0,max)+'‚Ä¶':t; }

    function speakText(text){
      if(!('speechSynthesis' in window)){ alert('Speech not supported on this browser'); return; }
      try{
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-AU'; u.rate = 1.0; u.pitch = 1.0;
        window.speechSynthesis.speak(u);
      }catch(e){ console.warn('TTS error:', e); }
    }

    // ----- QUICK ‚Üí EXPAND extraction & rendering -----
    function extractStructuredAnswer(outputText, fallbackSourcesArray) {
      if (!outputText || typeof outputText !== 'string') return null;

      const raw = outputText.trim();

      // A) Pure JSON
      if (raw.startsWith('{')) {
        try {
          const obj = JSON.parse(raw);
          if (obj.quick || obj.headline) return normalize(obj, fallbackSourcesArray);
        } catch (e) {}
      }

      // B) ```json ‚Ä¶ ```
      const fenceMatch = outputText.match(/```json\s*([\s\S]*?)\s*```/i);
      if (fenceMatch) {
        try {
          const obj = JSON.parse(fenceMatch[1]);
          if (obj.quick || obj.headline) return normalize(obj, fallbackSourcesArray);
        } catch (e) {}
      }

      // C) Parse markdown sections by headings
      return parseMarkdownAnswer(outputText, fallbackSourcesArray);

      function normalize(obj, srcs) {
        return {
          headline: obj.headline || '',
          quick: Array.isArray(obj.quick) ? obj.quick : [],
          why: obj.why || '',
          who: Array.isArray(obj.who) ? obj.who : [],
          bring: Array.isArray(obj.bring) ? obj.bring : [],
          redflags: obj.redflags || '',
          sources: Array.isArray(obj.sources) ? obj.sources : (srcs || [])
        };
      }
    }

    function parseMarkdownAnswer(md, fallbackSourcesArray) {
      const sections = {
        headline: '', quick: [], why: '', who: [], bring: [], redflags: '', sources: fallbackSourcesArray || []
      };

      const firstLine = md.split('\n').find(l => l.trim());
      sections.headline = (firstLine || '').replace(/^#+\s*/,'').slice(0, 120);

      sections.quick = extractBullets(md, /(##|###)\s*What to do now/i);
      sections.why = extractParagraph(md, /(##|###)\s*Why this matters/i);
      sections.who = extractBullets(md, /(##|###)\s*Who to contact/i);
      sections.bring = extractBullets(md, /(##|###)\s*What to bring/i);
      sections.redflags = extractParagraph(md, /(##|###)\s*(Watch for.*|Red-?flags?|Urgent)/i) || '';

      if (!sections.sources || !Array.isArray(sections.sources) || sections.sources.length === 0) {
        sections.sources = extractLinks(md).map(href => ({ filename: href, file_id: href, quote: '' }));
      }
      return sections;

      function between(md, startRe, nextRe) {
        const start = md.search(startRe);
        if (start === -1) return '';
        const rest = md.slice(start);
        const nextIdx = rest.search(nextRe);
        return nextIdx === -1 ? rest : rest.slice(0, nextIdx);
      }
      function extractBullets(md, headingRe) {
        const block = between(md, headingRe, /(##|###)\s+/i);
        return (block.match(/^\s*[-*‚Ä¢]\s+.+$/gm) || []).map(s => s.replace(/^\s*[-*‚Ä¢]\s+/, '').trim());
      }
      function extractParagraph(md, headingRe) {
        const block = between(md, headingRe, /(##|###)\s+/i).replace(headingRe,'');
        const para = block.split('\n').map(l=>l.trim()).filter(Boolean).join(' ');
        return para.slice(0, 1000);
      }
      function extractLinks(md) {
        const links = [];
        const re = /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g;
        let m; while ((m = re.exec(md)) !== null) { links.push(m[2]); }
        return links;
      }
    }

    function renderExpandableAnswer(containerEl, data) {
      if (!containerEl || !data) return;

      const {
        headline = '',
        quick = [],
        why = '',
        who = [],
        bring = [],
        redflags = '',
        sources = []
      } = data;

      const el = document.createElement('div');
      el.className = 'fq-card';
      el.innerHTML = `
        <div class="fq-topline">
          <span class="pill">Quick answer</span>
          <span aria-hidden="true">‚Ä¢</span>
          <span class="pill" style="background:#dcfce7;border-color:#bbf7d0;color:#14532d">Information only</span>
        </div>

        <div class="fq-h2">${escapeHtml(headline || 'What to do now')}</div>

        <div class="fq-quick">
          ${quick.length ? `<ul>${quick.map(li => `<li>${escapeHtml(li)}</li>`).join('')}</ul>` : `<p>No immediate steps provided.</p>`}
          <div class="fq-disclaimer">This is general information ‚Äî not a medical diagnosis. In an emergency call 000.</div>
        </div>

        <div class="fq-cta" aria-label="Helpful quick actions">
          <button class="fq-btn" data-target="exp-why">Why this matters</button>
          <button class="fq-btn" data-target="exp-who">Who to contact</button>
          <button class="fq-btn" data-target="exp-bring">What to bring</button>
          <button class="fq-btn" data-target="exp-red">Red-flags</button>
          <button class="fq-btn" data-target="exp-src">Sources</button>
        </div>

        <details id="exp-why" class="fq-exp">
          <summary>Why this matters</summary>
          <div class="fq-exp-body">${why ? escapeHtml(why) : '‚Äî'}</div>
        </details>

        <details id="exp-who" class="fq-exp">
          <summary>Who to contact</summary>
          <div class="fq-exp-body">
            ${who.length ? `<ul>${who.map(li => `<li>${escapeHtml(li)}</li>`).join('')}</ul>` : '‚Äî'}
          </div>
        </details>

        <details id="exp-bring" class="fq-exp">
          <summary>What to bring to your appointment</summary>
          <div class="fq-exp-body">
            ${bring.length ? `<ul>${bring.map(li => `<li>${escapeHtml(li)}</li>`).join('')}</ul>` : '‚Äî'}
          </div>
        </details>

        <details id="exp-red" class="fq-exp" ${redflags ? 'open' : ''}>
          <summary>Watch for & act on ‚Äî urgent red-flags</summary>
          <div class="fq-exp-body">
            ${redflags ? `<div class="fq-red" role="alert"><strong>Call 000 now</strong> ‚Äî ${escapeHtml(redflags)}</div>` : '‚Äî'}
          </div>
        </details>

        <details id="exp-src" class="fq-exp">
          <summary>Sources (Australia)</summary>
          <div class="fq-exp-body fq-sources">
            ${
              Array.isArray(sources) && sources.length
              ? `<ul>${sources.map(s => {
                  const href = s.url || (s.file_id && String(s.file_id).startsWith('http') ? s.file_id : null);
                  const label = s.title || s.filename || s.url || s.file_id || 'Source';
                  const link = href ? `<a href="${escapeAttr(href)}" target="_blank" rel="noopener">${escapeHtml(label)}</a>` : escapeHtml(label);
                  const quote = s.quote ? `<div class="fq-disclaimer" style="margin-top:4px">‚Äú${escapeHtml(s.quote)}‚Äù</div>` : '';
                  return `<li>${link}${quote}</li>`;
                }).join('')}</ul>`
              : '<div>No sources provided.</div>'
            }
          </div>
        </details>

        <div class="fq-disclaimer" style="margin-top:10px">
          Information only ‚Äî not a medical diagnosis. In an emergency call 000.
        </div>
      `;

      el.querySelectorAll('.fq-btn[data-target]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-target');
          const d = el.querySelector(`#${id}`);
          if (d) { d.open = true; d.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
        });
      });

      containerEl.appendChild(el);

      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
      function escapeAttr(s){ return String(s).replace(/"/g,'&quot;'); }
    }

    // ----- Add messages (now uses Quick ‚Üí Expand when possible) -----
    function addMsg(role,text,sources){
      TRANSCRIPT.push({role, text: text || ''});
      const chat=document.getElementById('chat');
      const div=document.createElement('div'); div.className='msg '+role;

      if(role==='assistant'){
        // Try structured + renderer first
        const structured = extractStructuredAnswer(text || '', sources);
        if (structured && (structured.quick.length || structured.why || structured.redflags || (structured.sources && structured.sources.length))) {
          renderExpandableAnswer(div, structured);
        } else {
          // Fallback to markdown
          div.innerHTML=mdToHtml(text||'');
          // Legacy sources block (optional)
          if(Array.isArray(sources)&&sources.length){
            const src=document.createElement('div'); src.className='sources';
            let html='<strong>Sources</strong><ul>';
            for(const s of sources){
              const href = s.url || `/api/file?file_id=${encodeURIComponent(s.file_id)}`;
              html+=`<li>
                <a href="${href}" target="_blank" rel="noopener">${s.filename || s.title || s.file_id || s.url || 'Source'}</a>
                ${s.quote && s.quote.trim()?`<div class="src-quote">‚Äú${trimQuote(s.quote)}‚Äù</div>`:''}
              </li>`;
            }
            html+='</ul>'; src.innerHTML=html; div.appendChild(src);
          }
        }

        // Listen button (works for both render paths)
        const controls=document.createElement('div'); controls.className='inline-controls';
        const listenBtn=document.createElement('button'); listenBtn.className='mini-btn'; listenBtn.textContent='üîä Listen';
        listenBtn.addEventListener('click',()=>speakText(text||'')); controls.appendChild(listenBtn);
        div.appendChild(controls);

      } else {
        div.textContent=text;
      }

      chat.appendChild(div);
      chat.scrollTop=chat.scrollHeight;
      return div;
    }

    function showThinking(){
      const div=addMsg('assistant','');
      div.innerHTML = '<span class="thinking"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Thinking‚Ä¶</span>';
      return div;
    }

    // ----- Copy / Reset -----
    async function copyConversation(){
      if(!navigator.clipboard){ alert('Clipboard not available'); return; }
      const text = TRANSCRIPT.map(m=>`${m.role.toUpperCase()}: ${m.text}`).join('\n\n');
      await navigator.clipboard.writeText(text || '(empty)');
      const btn=document.getElementById('copyBtn'); const old=btn.textContent;
      btn.textContent='Copied ‚úì'; setTimeout(()=>btn.textContent=old,1200);
    }
    function resetChat(){ TRANSCRIPT.splice(0,TRANSCRIPT.length); document.getElementById('chat').innerHTML=''; }

    // ----- Speech-to-Text (mic) -----
    let recognition = null; let listening = false;
    function getRecognition(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR) return null;
      const r = new SR(); r.lang='en-AU'; r.interimResults=false; r.maxAlternatives=1; return r;
    }
    function updateMicUI(active){
      const btn = document.getElementById('micBtn');
      if(active){ btn.classList.add('mic-recording'); btn.innerHTML='‚è∫Ô∏è<span class="mic-dot"></span>'; btn.title='Stop recording'; }
      else { btn.classList.remove('mic-recording'); btn.textContent='üé§'; btn.title='Speak your question'; }
    }
    function startListening(){
      if(listening) return;
      recognition = getRecognition();
      if(!recognition){ alert('Speech recognition not supported in this browser. Try Chrome or Edge.'); return; }
      listening = true; updateMicUI(true);
      recognition.onresult = (e)=>{ const transcript=e.results[0][0].transcript; document.getElementById('msg').value=transcript; sendMsg(transcript); };
      recognition.onerror = ()=>{ updateMicUI(false); listening=false; };
      recognition.onend = ()=>{ updateMicUI(false); listening=false; };
      try{ recognition.start(); }catch(e){ updateMicUI(false); listening=false; }
    }
    function stopListening(){ if(recognition && listening){ try{ recognition.stop(); }catch(e){} } }

    // ----- Send message (stays on prompt view) -----
    async function sendMsg(txt){
      // Ensure we are on the prompt view (chat area is here)
      categoryView.classList.remove('active');
      promptView.classList.add('active');

      const inp=document.getElementById('msg');
      const content=(txt || inp.value || '').trim(); if(!content) return;
      addMsg('user',content);
      inp.value=''; document.getElementById('sendBtn').disabled=true;
      const thinkingEl = showThinking();
      try{
        const r=await fetch('/api/mascot',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({message:content, cf_token: captchaToken})
        });
        const data=await r.json().catch(()=>({}));
        thinkingEl.remove();
        if(!r.ok){
          if(r.status===429){ addMsg('assistant','You‚Äôve reached today‚Äôs limit for this demo. Please try again tomorrow.'); }
          else if(r.status===504){ addMsg('assistant','Sorry ‚Äî the assistant is taking longer than usual. Please try again.'); }
          else { const detail=typeof data?.detail==='string'?` (${data.detail})`:''; addMsg('assistant','Sorry ‚Äî server error'+detail); }
        } else {
          addMsg('assistant', data.output || 'No response', data.sources);
        }
      }catch(e){
        thinkingEl.remove();
        addMsg('assistant','Sorry ‚Äî network error.');
      }finally{
        document.getElementById('sendBtn').disabled=false;
      }
    }

    // ----- Category badge helpers -----
    function setActiveCategory(label){
      const shortLabel = (label || '').split(' ‚Äì ')[0] || label || 'General';
      activeCategoryTextEl.textContent = `You‚Äôre asking about: ${shortLabel}`;
      activeCategoryEl.style.display = 'inline-flex';
    }
    function clearActiveCategory(){
      activeCategoryEl.style.display = 'none';
      activeCategoryTextEl.textContent = 'You‚Äôre asking about: ‚Ä¶';
    }

    // ----- Categories & prompts -----
    async function loadPrompts(){
      const res = await fetch('/prompts.json');
      PROMPTS = await res.json();
      renderCategories();
    }

    function categoryEmoji(label){
      if(label.startsWith('Psychological')) return EMOJI.Psychological;
      if(label.startsWith('Physical')) return EMOJI.Physical;
      if(label.startsWith('Career')) return EMOJI.Career;
      if(label.startsWith('Family')) return EMOJI.Family;
      if(label.startsWith('Cultural')) return EMOJI.Cultural;
      if(label.startsWith('Identity')) return EMOJI.Identity;
      if(label.startsWith('Financial')) return EMOJI.Financial;
      if(label.startsWith('Environmental')) return EMOJI.Environmental;
      if(label.startsWith('Female')) return EMOJI.Female;
      return '‚ùñ';
    }

    function renderCategories(){
      categoryView.innerHTML = '';
      Object.keys(PROMPTS).forEach(label=>{
        const card = document.createElement('div');
        card.className = 'category-card';
        const em = document.createElement('div'); em.className='category-emoji'; em.textContent = categoryEmoji(label);
        const textWrap = document.createElement('div');
        const title = document.createElement('div'); title.className='category-title'; title.textContent = label.split(' ‚Äì ')[0];
        const sub = document.createElement('div'); sub.className='category-sub'; sub.textContent = label.split(' ‚Äì ')[1] || '';
        textWrap.appendChild(title); textWrap.appendChild(sub);
        card.appendChild(em); card.appendChild(textWrap);
        card.addEventListener('click',()=>showPrompts(label));
        categoryView.appendChild(card);
      });
      categoryView.classList.add('active');
      promptView.classList.remove('active');
      // clear state
      resetChat();
      document.getElementById('msg').value='';
      clearActiveCategory();
    }

    function showPrompts(label){
      promptTitle.textContent = label;
      setActiveCategory(label);
      promptList.innerHTML = '';
      (PROMPTS[label]||[]).forEach(p=>{
        const btn = document.createElement('button');
        btn.className = 'prompt-btn';
        btn.textContent = p;
        btn.addEventListener('click',()=>sendMsg(p));
        promptList.appendChild(btn);
      });
      categoryView.classList.remove('active');
      promptView.classList.add('active');
    }

    function showCategories(){ renderCategories(); }

    // Init
    document.getElementById('copyBtn').addEventListener('click', copyConversation);
    document.getElementById('resetBtn').addEventListener('click', resetChat);
    document.getElementById('micBtn').addEventListener('click', ()=> listening ? stopListening() : startListening());
    document.addEventListener('DOMContentLoaded', loadPrompts);
  </script>
</body>
</html>
