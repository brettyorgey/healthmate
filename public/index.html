<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FifthQtr Healthmate</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --card-bg:#ffffff; --page-bg:#f7f9fc; --text:#0f172a; --muted:#4b5563; --brand:#0ea5e9; }
    body { margin:0; background:var(--page-bg); color:var(--text); font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    .wrap { width:70%; max-width:1000px; min-width:320px; margin:24px auto; padding:0 16px; }

    /* Header */
    .hero { background: rgb(0,91,181); border-radius:16px; padding:24px; box-shadow:0 4px 14px rgba(15,23,42,0.08); margin-bottom:12px; color:#fff; }
    .hero h1 { margin:0 0 8px; font-size:28px; line-height:1.2; color:#fff; }
    .hero p { margin:6px 0 0; color:#e0e7ff; }

    /* Categories */
    .categories { display:flex; flex-direction:column; gap:10px; margin:16px 0; }
    .category-card{ display:flex; gap:12px; align-items:center; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:14px 16px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.05); }
    .category-card:hover{ background:#f9fafb; }
    .category-emoji{ font-size:22px; }
    .category-title{ font-weight:700; }
    .category-sub{ color:#64748b; font-size:14px; }

    /* Panel */
    .prompt-panel{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:14px 16px; box-shadow:0 2px 6px rgba(0,0,0,.05); display:flex; flex-direction:column; gap:12px; min-height:70vh; }
    .prompt-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:12px; }
    .back-link{ color:var(--brand); text-decoration:underline; cursor:pointer; font-size:14px; }

    .prompts{ display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .prompt-btn{ text-align:left; border:1px solid #e5e7eb; background:#fff; border-radius:10px; padding:10px 12px; cursor:pointer; font-size:15px; }
    .prompt-btn:hover{ background:#f9fafb; }

    .cat-tag{ display:inline-flex; align-items:center; gap:8px; background:#e0f2fe; color:#075985; border:1px solid #bae6fd; padding:6px 10px; border-radius:999px; font-size:13px; font-weight:600; margin:8px 0 16px; }
    .cat-tag .dot{ width:6px; height:6px; border-radius:50%; background:#0ea5e9; display:inline-block; }

    /* Scroll area so footer can stick */
    .scroll-area{ display:flex; flex-direction:column; gap:12px; overflow:auto; max-height: calc(70vh - 150px); padding-right:4px; }

    /* Chat */
    .chat{ background:#fff; border-radius:12px; padding:12px; border:1px dashed #e5e7eb; display:flex; flex-direction:column; gap:10px; }
    .msg{ max-width:80%; white-space:pre-wrap; }
    .msg.user{ align-self:flex-end; background:#dbeafe; color:#0f172a; padding:10px 12px; border-radius:12px 12px 0 12px; text-align:right; }
    .msg.assistant{ display:flex; flex-direction:column; align-self:flex-start; background:#f8fafc; color:#0f172a; padding:10px 12px; border-radius:12px 12px 12px 0; }
    .msg.assistant .sources { order: 2; }
    .inline-controls{ order: 3; margin-top: 8px; align-self: flex-start; }

    /* Instruction headings spacing + blue bar */
    .msg.assistant h2, .msg.assistant h3{
      margin-top: 26px;
      margin-bottom: 12px;
      font-size:18px; line-height:1.3;
      border-left:4px solid var(--brand);
      padding-left:8px;
    }
    .msg.assistant h2:first-of-type,
    .msg.assistant h3:first-of-type { margin-top: 12px; }
    .msg.assistant p { margin: 8px 0 12px; }

    /* Assistant list styling (for markdown lists) */
    .msg.assistant ul { margin: 0.25rem 0 0.75rem 1.25rem; padding: 0; }
    .msg.assistant li { margin: 0.25rem 0; }

    /* Sources box */
    .sources { margin-top:12px; padding:10px; border:1px solid #e5e7eb; border-radius:10px; background:#f9fafb; }
    .sources strong{ display:block; margin-bottom:6px; }
    .sources ul{ margin:0; padding-left:18px; }
    .sources li{ margin-bottom:4px; }
    .sources a{ color:var(--brand); text-decoration:underline; }

    /* Thinking animation */
    .thinking{ display:inline-flex; gap:6px; align-items:center; color:#475569; }
    .dot{ width:6px; height:6px; border-radius:50%; background:#94a3b8; opacity:.6; animation:b 1.3s infinite ease-in-out; }
    .dot:nth-child(2){ animation-delay:.15s; } .dot:nth-child(3){ animation-delay:.3s; }
    @keyframes b { 0%,80%,100%{ transform:scale(0.7); opacity:.4; } 40%{ transform:scale(1); opacity:1; } }

    /* Input + footer */
    .inputRow{ display:flex; gap:10px; align-items:stretch; }
    textarea#msg{ flex:1; padding:14px 16px; font-size:16px; line-height:1.35; border-radius:12px; border:1px solid #e5e7eb; resize:vertical; min-height:72px; max-height:300px; }
    button.send{ padding:14px 18px; border-radius:12px; border:0; background:var(--brand); color:#fff; cursor:pointer; font-size:16px; font-weight:600; }
    button.send[disabled]{ opacity:.6; cursor:not-allowed; }

    .chat-footer{ position:sticky; bottom:0; background:#fff; border-top:1px solid #e5e7eb; padding:10px 0 6px; font-size:13px; color:#475569; display:flex; flex-direction:column; gap:8px; }
    .chat-controls{ display:flex; gap:10px; }
    .btn-sm{ padding:8px 10px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; font-size:13px; }
    .btn-sm:hover{ background:#f9fafb; }

    /* Mic button */
    .btn-icon{ padding:0 14px; border-radius:12px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; font-size:18px; display:flex; align-items:center; justify-content:center; min-width:56px; }
    .btn-icon:hover{ background:#f9fafb; }
    .mic-recording{ color:#dc2626; border-color:#fecaca; background:#fff5f5; }
    .mic-dot{ display:inline-block; width:8px; height:8px; border-radius:50%; background:#ef4444; margin-left:6px; animation:pulse 1s infinite; }
    @keyframes pulse{ 0%{ transform:scale(.85); opacity:.7;} 50%{ transform:scale(1); opacity:1;} 100%{ transform:scale(.85); opacity:.7;} }

    #categoryView, #promptView { display:none; }
    #categoryView.active, #promptView.active { display:block; }

    /* ---------- Triage CTA card (tight) ---------- */
    .triage-cta {
      margin: 6px 0 4px !important;
      padding-top: 8px;
      border-top: 1px solid #cbd5e1;
      animation: triageFadeIn 0.4s ease forwards;
    }
    .triage-cta__inner {
      border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px;
      background:#ffffff; box-shadow:0 2px 8px rgba(0,0,0,.04);
    }
    .triage-cta__inner h3 { margin:2px 0 4px !important; font-size:16px; border-left:3px solid #0ea5e9; padding-left:6px; }
    .triage-cta__inner p  { margin:0 0 6px !important; color:#475569; }
    .triage-btns { display:flex; gap:6px; flex-wrap:wrap; }
    .triage-cta__btn {
      display:inline-flex; align-items:center; gap:6px; justify-content:center; line-height:1.2;
      padding:8px 12px; border-radius:10px;
      border:1px solid #0284c7; background:#0ea5e9; color:#fff;
      text-decoration:none; font-weight:600; transition:all .15s ease;
    }
    .triage-cta__btn:hover { background:#0284c7; border-color:#0284c7; opacity:1; }
    .triage-cta__btn.secondary-blue { background:#fff; color:#0ea5e9; border:1px solid #0ea5e9; }
    .triage-cta__btn.secondary-blue:hover { background:#e0f2fe; }
    .triage-note { margin:6px 0 0; font-size:12px; color:#64748b; opacity:0; animation: triageFadeIn .4s ease forwards; }
    @keyframes triageFadeIn { from {opacity:0; transform:translateY(2px);} to {opacity:1; transform:translateY(0);} }
    @media (max-width: 480px){
      .triage-btns { flex-direction:column; align-items:stretch; }
      .triage-cta__btn { width:100%; justify-content:center; font-size:15px; padding:12px 14px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>Welcome ‚Äî we‚Äôre here to support past players & families.</h1>
      <p>Information only ‚Äî not a medical diagnosis. Please see your GP for advice. In an emergency call 000.</p>
      <p>Please select a category from the options below, you'll then be provided prompt options or you can type your question into the chat.</p>
    </div>

    <!-- Categories (first screen) -->
    <div id="categoryView" class="categories active" aria-live="polite"></div>

    <!-- Prompts + chat -->
    <div id="promptView" class="prompt-panel" aria-live="polite">
      <div class="prompt-header">
        <div id="promptTitle" class="category-title"></div>
        <div class="back-link" onclick="showCategories()">‚Üê Back to Categories</div>
      </div>

      <div id="activeCategory" class="cat-tag" style="display:none;">
        <span class="dot"></span>
        <span id="activeCategoryText">You‚Äôre asking about: ‚Ä¶</span>
        <a href="javascript:void(0)" onclick="showCategories()">Change category</a>
      </div>

      <div class="scroll-area" id="scrollArea">
        <div id="promptList" class="prompts"></div>
        <div class="chat" id="chat" aria-live="polite"></div>
      </div>

      <div class="inputRow">
        <button class="btn-icon" id="micBtn" title="Speak your question" type="button">üé§</button>
        <textarea id="msg" rows="3" placeholder="Type your question‚Ä¶"></textarea>
        <button class="send" id="sendBtn" type="button" onclick="sendMsg()">Send</button>
      </div>

      <div class="chat-footer">
        <div>Information only ‚Äî not a medical diagnosis. In an emergency call 000.</div>
        <div class="chat-controls">
          <button class="btn-sm" id="copyBtn" type="button">Copy conversation</button>
          <button class="btn-sm" id="resetBtn" type="button">Reset chat</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ---------- TRIAGE HELPERS (client-side) ---------- */
    async function triageLoadRules(){
      try { const r = await fetch('/triage.json', {cache:'no-store'}); return r.ok ? r.json() : []; }
      catch { return []; }
    }
    function triageTextHasAny(text, list){
      if(!list || !list.length) return true;
      const t = (text||'').toLowerCase();
      return list.some(k => t.includes(k.toLowerCase()));
    }
    function triageMatches(rule, ctx){
      const w = rule.when || {};
      if (w.categories && w.categories.length && !w.categories.includes(ctx.category)) return false;
      if (w.anyKeywords && w.anyKeywords.length && !triageTextHasAny(ctx.userText, w.anyKeywords)) return false;
      if (w.allKeywords && w.allKeywords.length && !w.allKeywords.every(k => (ctx.userText||'').toLowerCase().includes(k.toLowerCase()))) return false;
      if (w.excludeKeywords && w.excludeKeywords.length && w.excludeKeywords.some(k => (ctx.userText||'').toLowerCase().includes(k.toLowerCase()))) return false;
      return true;
    }
    function triageBuildStoryUrl(btnOrAction, ctx){
      const explicit = btnOrAction.href;
      if (explicit) {
        try {
          const u = new URL(explicit, location.origin);
          if (btnOrAction.utm) { for (const [k,v] of Object.entries(btnOrAction.utm)) u.searchParams.set('utm_'+k, v); }
          if (btnOrAction.includeTranscript) {
            const payload = { category: ctx.category, promptId: ctx.promptId, lastUserMessage: (ctx.userText||'').slice(0,1200) };
            const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
            u.searchParams.set('context_b64', b64);
            u.searchParams.set('cat', ctx.category || '');
            u.searchParams.set('prompt', ctx.promptId || '');
            u.searchParams.set('from', 'healthmate');
          }
          return u.toString();
        } catch { /* fall back */ }
      }
      const base = 'https://fifthqtr.org.au/story-form/';
      const q = new URLSearchParams();
      q.set('cat', ctx.category || '');
      q.set('prompt', ctx.promptId || '');
      q.set('from','healthmate');
      if (btnOrAction.utm){ for (const [k,v] of Object.entries(btnOrAction.utm)) q.set(`utm_${k}`, v); }
      if (btnOrAction.includeTranscript){
        const payload = { category: ctx.category, promptId: ctx.promptId, lastUserMessage: (ctx.userText||'').slice(0,1200) };
        const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
        q.set('context_b64', b64);
      }
      return `${base}?${q.toString()}`;
    }
    function triageBuildExternalUrl(btn){ return btn.href || '#'; }
    function triageRenderCTA(container, action, ctx){
      container.querySelectorAll('.triage-cta').forEach(n=>n.remove());
      const wrapper = document.createElement('div');
      wrapper.className = 'triage-cta';

      if (action.type === 'showStoryCTA'){
        const url = triageBuildStoryUrl(action, ctx);
        wrapper.innerHTML = `
          <div class="triage-cta__inner">
            <h3>${action.label || 'Share your story'}</h3>
            <p>Tell us what‚Äôs happening so we can connect you to the right support.</p>
            <div class="triage-btns">
              <a class="triage-cta__btn" href="${url}" target="_blank" rel="noopener">üìù Tell your story (FifthQtr)</a>
            </div>
          </div>`;
      } else {
        const title = action.title || action.label || 'Next options';
        const body  = action.body  || 'Choose what feels right for you:';
        wrapper.innerHTML = `
          <div class="triage-cta__inner">
            <h3>${title}</h3>
            <p>${body}</p>
            <div class="triage-btns"></div>
          </div>`;
        const btnWrap = wrapper.querySelector('.triage-btns');
        if (Array.isArray(action.buttons)){
          action.buttons.forEach(btn=>{
            const a = document.createElement('a');
            const styleClass = btn.style ? ` ${btn.style}` : (btn.kind === 'external' ? ' secondary-blue' : '');
            a.className = 'triage-cta__btn' + styleClass;
            a.textContent = btn.label || (btn.kind === 'story' ? 'üìù Tell your story (FifthQtr)' : 'üí¨ Join a forum (SANE)');
            if (btn.kind === 'story'){
              a.href = triageBuildStoryUrl(btn, ctx);
              a.target = '_blank'; a.rel='noopener';
            } else {
              a.href = triageBuildExternalUrl(btn);
              a.target = (btn.target || '_blank'); a.rel='noopener';
            }
            a.setAttribute('aria-label', a.textContent + ' (opens in new tab)');
            btnWrap.appendChild(a);
          });
        }
        if (Array.isArray(action.buttons) && action.buttons.length > 1) {
          const note = document.createElement('p');
          note.className = 'triage-note';
          note.textContent = 'Links open in a new tab. You can keep chatting here anytime.';
          wrapper.querySelector('.triage-cta__inner').appendChild(note);
        }
      }
      const sources = container.querySelector('.sources');
      if (sources && sources.parentElement === container) container.insertBefore(wrapper, sources);
      else container.appendChild(wrapper);
    }
    /**
     * ctx = { category, promptId, userText, assistantEl }
     */
    async function triageEvaluateAndRender(ctx){
      const rules = await triageLoadRules();
      const matches = rules
        .filter(r => triageMatches(r, ctx))
        .sort((a,b) => (b.action?.priority || 0) - (a.action?.priority || 0));
      if (!matches.length || !ctx.assistantEl) return;
      const chosen = matches[0];
      if (!chosen.action) return;
      if (chosen.action.type !== 'showStoryCTA' && chosen.action.type !== 'showOptions') return;
      const delay = chosen.action.delayMs || 0;
      setTimeout(() => { triageRenderCTA(ctx.assistantEl, chosen.action, ctx); }, delay);
    }
  </script>

  <script>
    // Reset per-load
    sessionStorage.removeItem('fq_thread_id');
    sessionStorage.removeItem('fq_has_initial_answer');

    function removeDeadLinkMarkers(text){
      return (text || '').replace(/\s*\(link unavailable\)/gi, '');
    }

    // Canonical category key for the server
    function canonicalCategoryKey(label='') {
      const head = (label.split('‚Äì')[0] || label).trim().toLowerCase();
      const map = {
        'physical': 'physical',
        'psychological': 'psychological',
        'brain health': 'brain-health',
        'brain-health': 'brain-health',
        'career': 'career',
        'family': 'family',
        'cultural': 'cultural',
        'identity': 'identity',
        'financial': 'financial',
        'environmental': 'environmental',
        'female': 'female'
      };
      return map[head] || null;
    }

    // State
    const TRANSCRIPT=[]; let PROMPTS={};
    let CURRENT_PROMPT_ID = ''; // track last clicked prompt (slug)

    // DOM
    const categoryView=document.getElementById('categoryView');
    const promptView=document.getElementById('promptView');
    const promptTitle=document.getElementById('promptTitle');
    const promptList=document.getElementById('promptList');
    const chatEl=document.getElementById('chat');
    const activeCategoryEl=document.getElementById('activeCategory');
    const activeCategoryTextEl=document.getElementById('activeCategoryText');

    // Remove model "## Sources" so we only show curated links
    function stripSourcesSection(md){
      if (!md) return md;
      return md.replace(/(^|\n)##\s*Sources[\s\S]*?(?=\n##\s|\n?$)/i, '$1');
    }

    // Escape HTML
    function esc(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // Minimal Markdown ‚Üí HTML (links, h2/h3, bold, bullet lists, paragraphs)
    function mdToHtml(md){
      if(!md) return '';
      let s = esc(md);

      // clickable links: [label](https://...)
      s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
        (_m,label,url) => `<a href="${url}" target="_blank" rel="noopener noreferrer">${label}</a>`);

      // headings (do h3 before h2)
      s = s.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>');
      s = s.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>');

      // bold
      s = s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');

      // simple bullet lists (pure blocks of "- " lines)
      s = s.replace(/(^|\n)(?:- .*(?:\n- .*)*)/g, (block) => {
        const lines = block.trim().split('\n');
        if (!lines.every(l => l.trim().startsWith('- '))) return block;
        const items = lines.map(l => `<li>${l.trim().slice(2)}</li>`).join('');
        return `\n<ul>${items}</ul>`;
      });

      // paragraphs / line breaks (avoid wrapping existing block elements)
      const blocks = s.split(/\n{2,}/).map(chunk => {
        if (/^\s*(<h2|<h3|<ul|<p|<blockquote|<pre|<table|<ol)/i.test(chunk)) return chunk;
        return `<p>${chunk.replace(/\n/g,'<br/>')}</p>`;
      });
      return blocks.join('\n');
    }

    // Sources box (ONLY from data.sources)
    function renderSourcesBox(parent, sources){
      if(!Array.isArray(sources) || !sources.length) return;
      parent.querySelectorAll('.sources, .inline-controls').forEach(n => n.remove());

      const box = document.createElement('div');
      box.className = 'sources';
      const h = document.createElement('strong');
      h.textContent = 'Sources';
      box.appendChild(h);

      const ul = document.createElement('ul');
      for(const s of sources){
        const li = document.createElement('li');
        if(s.url){
          const a = document.createElement('a');
          a.href = s.url;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.textContent = s.title || s.url;
          li.appendChild(a);
        } else if (s.file_id){
          const a = document.createElement('a');
          a.href = `/api/file?file_id=${encodeURIComponent(s.file_id)}`;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.textContent = s.filename || 'Document';
          li.appendChild(a);
        } else {
          li.textContent = s.title || s.filename || 'Source';
        }
        ul.appendChild(li);
      }
      box.appendChild(ul);
      parent.appendChild(box);

      const controls = document.createElement('div');
      controls.className = 'inline-controls';
      const listenBtn = document.createElement('button');
      listenBtn.type = 'button';
      listenBtn.className = 'btn-sm';
      listenBtn.textContent = 'üîä Listen';
      listenBtn.addEventListener('click', ()=> {
        const text = parent.textContent || '';
        speakText(text);
      });
      controls.appendChild(listenBtn);
      parent.appendChild(controls);
    }

    function normalizeFollowupHeadings(text){
      if(!text) return '';
      return text
        .replace(/^\s*Why this matters.*$/gmi,'## Why this matters')
        .replace(/^\s*Sources.*$/gmi,'## Sources');
    }
    function normalizeSectionHeadings(text){
      if(!text) return text;
      const list=['What to do now','Why this matters','Who to contact','What to bring','Watch for and act on','Red-flags','Sources'];
      let out=text;
      for(const h of list){
        const re=new RegExp(`^\\s*\\**\\s*${h}\\s*:?\\s*\\**\\s*$`,'gmi');
        out=out.replace(re,`## ${h}`);
      }
      return out;
    }
    function stripInlineDisclaimer(text){
      if(!text) return text;
      return text.replace(/Information only\s*‚Äî\s*not a medical diagnosis.*000\.*\s*/gmi,'').trim();
    }
    function cleanFooterHeading(text){
      if (!text) return text;
      let out = text.replace(/^\s*-{3,}\s*$/gmi, '');
      out = out.replace(/^\s*(?:#{1,6}\s*)?(?:\*{0,2}\s*)?(?:\d+\)\s*)?Footer\s*:?\s*(?:\*{0,2})?\s*$/gmi,'');
      out = out.replace(/\n{3,}/g, '\n\n').trim();
      return out;
    }

    /* TTS (Listen) */
    function speakText(text){
      if(!('speechSynthesis' in window)){ alert('Speech not supported on this browser'); return; }
      try{
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-AU'; u.rate = 1.0; u.pitch = 1.0;
        window.speechSynthesis.speak(u);
      }catch(e){ console.warn('TTS error:', e); }
    }

    /* STT (Mic) */
    let recognition = null, listening = false;
    function getRecognition(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR) return null;
      const r = new SR(); r.lang='en-AU'; r.interimResults=false; r.maxAlternatives=1; return r;
    }
    function updateMicUI(active){
      const btn = document.getElementById('micBtn');
      if(!btn) return;
      if(active){ btn.classList.add('mic-recording'); btn.innerHTML='‚è∫Ô∏è<span class="mic-dot"></span>'; btn.title='Stop recording'; }
      else { btn.classList.remove('mic-recording'); btn.textContent='üé§'; btn.title='Speak your question'; }
    }
    function startListening(){
      if(listening) return;
      recognition = getRecognition();
      if(!recognition){ alert('Speech recognition not supported in this browser. Try Chrome or Edge.'); return; }
      listening = true; updateMicUI(true);
      recognition.onresult = (e)=>{ const t=e.results[0][0].transcript; document.getElementById('msg').value=t; sendMsg(t); };
      recognition.onerror = ()=>{ updateMicUI(false); listening=false; };
      recognition.onend = ()=>{ updateMicUI(false); listening=false; };
      try{ recognition.start(); }catch(e){ updateMicUI(false); listening=false; }
    }
    function stopListening(){ if(recognition && listening){ try{ recognition.stop(); }catch(_){} } }

    // Client-side fetch with timeout
    async function fetchWithTimeout(url, options={}, ms=30000){
      const ctl = new AbortController(); const t = setTimeout(()=>ctl.abort(), ms);
      try { return await fetch(url, { ...options, signal: ctl.signal }); }
      finally { clearTimeout(t); }
    }

    function addMsg(role,text,sources){
      const entry = {role, text: text || ''};
      TRANSCRIPT.push(entry);
      const div=document.createElement('div'); div.className='msg '+role;

      if(role==='assistant'){
        const isFollowUp = sessionStorage.getItem('fq_has_initial_answer') === '1';
        let cleaned = normalizeSectionHeadings(text || '');
        if (isFollowUp) cleaned = normalizeFollowupHeadings(cleaned);
        cleaned = stripInlineDisclaimer(cleaned);
        cleaned = cleanFooterHeading(cleaned);
        cleaned = removeDeadLinkMarkers(cleaned);
        cleaned = stripSourcesSection(cleaned);
        div.innerHTML = mdToHtml(cleaned);

        if (Array.isArray(sources) && sources.length) {
          renderSourcesBox(div, sources);
        }

        if(!sessionStorage.getItem('fq_has_initial_answer')) sessionStorage.setItem('fq_has_initial_answer','1');
      } else {
        div.textContent = text;
      }
      chatEl.appendChild(div);
      chatEl.scrollTop=chatEl.scrollHeight;
      return div;
    }

    function showThinking(){
      const d = addMsg('assistant','');
      d.innerHTML = `
        <span class="thinking" role="status" aria-live="polite">
          Thinking‚Ä¶
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </span>`;
      return d;
    }

    async function pollUntilReady(threadId, originalUserText, thinkingEl, tries=12){
      for (let i=0; i<tries; i++){
        await new Promise(r=>setTimeout(r, 2500));
        const r = await fetchWithTimeout('/api/mascot', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            peek:true,
            thread_id: threadId,
            message: originalUserText,
            categoryLabel: promptTitle.textContent || '',
            categoryKey: canonicalCategoryKey(promptTitle.textContent || '')
          })
        }, 15000);
        const data = await r.json().catch(()=> ({}));
        if (r.ok && !data.pending && (data.output || data.error)){
          thinkingEl?.remove();
          if (data.error) {
            addMsg('assistant', 'Sorry ‚Äî server error ('+data.error+')');
          } else {
            const assistantEl = addMsg('assistant', data.output || 'No response', data.sources || []);
            triageEvaluateAndRender({
              category: promptTitle.textContent || '',
              promptId: CURRENT_PROMPT_ID || '',
              userText: originalUserText || '',
              assistantEl
            });
          }
          return;
        }
      }
      thinkingEl?.remove();
      addMsg('assistant', 'Still working ‚Äî please press ‚ÄúSend‚Äù again to retry.');
    }

    async function sendMsg(txt){
      categoryView.classList.remove('active');
      promptView.classList.add('active');

      const inp=document.getElementById('msg');
      const content=(txt||inp.value||'').trim(); if(!content) return;

      // If message is typed (no prompt button), clear any old prompt id
      if (typeof txt === 'undefined') CURRENT_PROMPT_ID = '';

      addMsg('user',content);
      inp.value=''; document.getElementById('sendBtn').disabled=true;
      const thinkingEl = showThinking();

      try{
        const isFollowUp = sessionStorage.getItem('fq_has_initial_answer') === '1';
        const threadId   = sessionStorage.getItem('fq_thread_id') || null;
        const catKey     = canonicalCategoryKey(promptTitle.textContent || '');

        const r = await fetchWithTimeout('/api/mascot',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            message: content,
            followup: isFollowUp,
            thread_id: threadId,
            categoryLabel: promptTitle.textContent || '',
            categoryKey: catKey
          })
        }, 30000);
        const data = await r.json().catch(()=> ({}));

        // still working? switch to polling
        if (r.status === 202 && data.pending && data.thread_id){
          sessionStorage.setItem('fq_thread_id', data.thread_id);
          await pollUntilReady(data.thread_id, content, thinkingEl);
          return;
        }

        thinkingEl.remove();

        if(!r.ok){
          addMsg('assistant','Sorry ‚Äî server error' + (data?.error ? ` (${data.error})` : ''));
          return;
        }

        // race guard: got thread but not the content yet
        if (data.thread_id && (data.output || '').trim().toLowerCase() === 'no response') {
          sessionStorage.setItem('fq_thread_id', data.thread_id);
          const thinkingAgain = showThinking();
          await pollUntilReady(data.thread_id, content, thinkingAgain);
          return;
        }

        // success
        const assistantEl = addMsg('assistant', data.output || 'No response', data.sources || []);
        if (data.thread_id) sessionStorage.setItem('fq_thread_id', data.thread_id);

        // Triage after assistant reply
        triageEvaluateAndRender({
          category: promptTitle.textContent || '',
          promptId: CURRENT_PROMPT_ID || '',
          userText: content || '',
          assistantEl
        });

      }catch(e){
        thinkingEl.remove();
        addMsg('assistant','Sorry ‚Äî network error.');
      }finally{
        document.getElementById('sendBtn').disabled=false;
      }
    }

    function resetChat(){ TRANSCRIPT.length=0; chatEl.innerHTML=''; sessionStorage.clear(); }

    function setActiveCategory(label){
      const short=(label||'').split(' ‚Äì ')[0]||label||'General';
      activeCategoryTextEl.textContent=`You‚Äôre asking about: ${short}`;
      activeCategoryEl.style.display='inline-flex';
    }
    function clearActiveCategory(){
      activeCategoryEl.style.display='none';
      activeCategoryTextEl.textContent='You‚Äôre asking about: ‚Ä¶';
    }

    function categoryEmoji(label){
      if(!label) return '‚ùñ';
      const map = [
        { key: 'Psychological',  emoji: 'üß†' },
        { key: 'Physical',       emoji: 'üèãÔ∏è' },
        { key: 'Career',         emoji: 'üíº' },
        { key: 'Family',         emoji: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶' },
        { key: 'Cultural',       emoji: 'üåè' },
        { key: 'Identity',       emoji: 'üé≠' },
        { key: 'Financial',      emoji: 'üí∞' },
        { key: 'Environmental',  emoji: '‚ö†Ô∏è' },
        { key: 'Female',         emoji: '‚ôÄÔ∏è' }
      ];
      const hit = map.find(m => label.startsWith(m.key));
      return hit ? hit.emoji : '‚ùñ';
    }

    async function loadPrompts(){
      const res = await fetch('/prompts.json');
      if (!res.ok) { console.error('Failed to load /prompts.json'); return; }
      PROMPTS = await res.json();
      renderCategories();
    }

    function renderCategories(){
      categoryView.innerHTML='';
      Object.keys(PROMPTS).forEach(label=>{
        const card=document.createElement('div'); card.className='category-card';
        const em=document.createElement('div'); em.className='category-emoji'; em.textContent = categoryEmoji(label);
        const textWrap=document.createElement('div');
        const title=document.createElement('div'); title.className='category-title'; title.textContent = label.split(' ‚Äì ')[0];
        const sub=document.createElement('div'); sub.className='category-sub'; sub.textContent = label.split(' ‚Äì ')[1] || '';
        textWrap.appendChild(title); textWrap.appendChild(sub);
        card.appendChild(em); card.appendChild(textWrap);
        card.addEventListener('click',()=>showPrompts(label));
        categoryView.appendChild(card);
      });
      categoryView.classList.add('active');
      promptView.classList.remove('active');
      resetChat();
      document.getElementById('msg').value='';
      clearActiveCategory();
      CURRENT_PROMPT_ID = '';
    }

    function showPrompts(label){
      sessionStorage.clear();
      promptTitle.textContent = label;
      setActiveCategory(label);
      promptList.innerHTML = '';
      (PROMPTS[label]||[]).forEach(p=>{
        const btn=document.createElement('button');
        btn.className='prompt-btn';
        btn.type='button';
        btn.textContent=p;
        btn.addEventListener('click',()=>{
          CURRENT_PROMPT_ID = (p || '').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
          sendMsg(p);
        });
        promptList.appendChild(btn);
      });
      categoryView.classList.remove('active');
      promptView.classList.add('active');
      document.getElementById('scrollArea').scrollTop=0;
    }
    function showCategories(){ renderCategories(); }

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
      loadPrompts();
      document.getElementById('copyBtn').addEventListener('click', ()=>navigator.clipboard.writeText(
        TRANSCRIPT.map(m=>`${m.role.toUpperCase()}: ${m.text}`).join('\n\n') || '(empty)'
      ));
      document.getElementById('resetBtn').addEventListener('click', resetChat);
      document.getElementById('msg').addEventListener('keydown', (e)=>{
        if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMsg(); }
      });
      document.getElementById('micBtn').addEventListener('click', ()=> listening ? stopListening() : startListening());
    });
  </script>
</body>
</html>
