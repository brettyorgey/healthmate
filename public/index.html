<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FifthQtr Healthmate</title>
  <meta name="description" content="FifthQtr Healthmate — supportive information for past AFL/AFLW players and families." />
  <style>
    :root {
      --brand:#0a2342;
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --bg:#f9fafb;
      --user:#eef2ff;
      --bot:#ffffff;
      --radius:12px;
    }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; display:flex; flex-direction:column; height:100vh; }
    header { background:var(--brand); color:#fff; padding:16px; font-size:20px; font-weight:700; }
    main { flex:1; display:flex; flex-direction:column; }
    #chat { flex:1; overflow-y:auto; padding:16px; }
    .row { margin:10px 0; display:flex; }
    .msg { max-width:820px; padding:12px 14px; border-radius:var(--radius); line-height:1.45; white-space:pre-wrap; }
    .user   { margin-left:auto; background:var(--user); }
    .assist { background:var(--bot); border:1px solid var(--line); }
    .welcome { background:#fff; border:1px solid var(--line); border-radius:var(--radius); padding:14px; }
    .welcome strong { display:block; margin-bottom:6px; }
    .starters { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
    .starter { border:1px solid var(--line); background:#fff; padding:10px 12px; border-radius:9999px; font-size:14px; cursor:pointer; }
    .starter:hover { background:#f3f4f6; }
    .tools { margin-top:8px; display:flex; gap:8px; }
    .tool-btn { font-size:12px; border:1px solid var(--line); background:#fff; padding:6px 8px; border-radius:8px; cursor:pointer; }
    #inputbar { display:flex; gap:8px; padding:12px; background:#fff; border-top:1px solid var(--line); }
    #msg { flex:1; padding:12px; border:1px solid var(--line); border-radius:10px; font-size:16px; }
    #send { padding:12px 18px; background:var(--brand); color:#fff; border:none; border-radius:10px; font-size:16px; cursor:pointer; }
    #send[disabled] { opacity:.6; cursor:wait; }
    footer { font-size:12px; color:var(--muted); padding:8px 16px; background:#fff; border-top:1px solid var(--line); }
    .loading { opacity:.5; font-style:italic; }
    @media (min-width: 900px) { #chat { padding:24px 32px; } }
  </style>
</head>
<body>
  <header>FifthQtr Healthmate</header>

  <main>
    <div id="chat" aria-live="polite">
      <!-- Welcome card with starter prompts -->
      <div class="welcome">
        <strong>Welcome — we’re here to support past players & families.</strong>
        This assistant provides general information to help you decide next steps and where to find reliable, Australian resources. It isn’t a medical diagnosis. In an emergency call <b>000</b>.
        <div class="starters" id="starters"></div>
        <div class="tools">
          <button class="tool-btn" id="copyForGP">Copy conversation for GP</button>
          <button class="tool-btn" id="resetChat">Reset chat</button>
        </div>
      </div>
    </div>

    <div id="inputbar">
      <input id="msg" placeholder="Type your question…" aria-label="Message input" />
      <button id="send" aria-label="Send message">Send</button>
    </div>

    <footer>
      This service provides general information only. Please see your GP for medical advice. In an emergency call <strong>000</strong>.
    </footer>
  </main>

  <script>
    // Point this at your Vercel function (relative works on Vercel)
    const ENDPOINT = "/api/mascot";

    const starters = [
      "My partner retired from footy 15 years ago and now gets headaches and forgets tasks — what should we do?",
      "I’m a retired player with mood swings and poor sleep — where can I find support?",
      "I left football 10+ years ago — are there Australian clinics that check memory and thinking?",
      "I’m caring for a former teammate with worsening headaches and anxiety — what help is available for partners/carers?",
      "What’s the difference between post-concussion symptoms and CTE, and where can I read reliable info?"
    ];

    // DOM
    const chat   = document.getElementById('chat');
    const msgInp = document.getElementById('msg');
    const send   = document.getElementById('send');
    const startersEl = document.getElementById('starters');
    const copyBtn = document.getElementById('copyForGP');
    const resetBtn = document.getElementById('resetChat');

    // Build starter buttons
    starters.forEach(s => {
      const b = document.createElement('button');
      b.className = 'starter';
      b.textContent = s;
      b.addEventListener('click', () => sendMsg(s));
      startersEl.appendChild(b);
    });

    const history = []; // {role:'user'|'assistant', text:string}

    function addMsg(role, text, extraClass='') {
      const row = document.createElement('div');
      row.className = 'row';
      const bubble = document.createElement('div');
      bubble.className = 'msg ' + (role === 'user' ? 'user' : 'assist') + (extraClass ? (' ' + extraClass) : '');
      bubble.textContent = text;
      row.appendChild(bubble);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
      history.push({ role, text });
    }

    function setSending(on) {
      if (on) { send.setAttribute('disabled', 'disabled'); send.textContent = 'Sending…'; }
      else     { send.removeAttribute('disabled'); send.textContent = 'Send'; }
    }

    async function sendMsg(text) {
      const content = (text || msgInp.value || '').trim();
      if (!content) return;
      addMsg('user', content);
      msgInp.value = '';
      setSending(true);
      try {
        const r = await fetch(ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ message: content })
        });
        const ok = r.ok;
        let data = null;
        try { data = await r.json(); } catch {}
        const output = data && data.output ? data.output : (ok ? 'Sorry — I could not generate a response.' : 'Sorry — network error.');
        addMsg('assistant', output);
      } catch (e) {
        addMsg('assistant', 'Sorry — network error.');
      } finally {
        setSending(false);
      }
    }

    function copyForGP() {
      const header = `FifthQtr Healthmate — Conversation Summary\n(Date: ${new Date().toLocaleString()})\n\n`;
      const body = history.map(h => (h.role === 'user' ? 'You: ' : 'Healthmate: ') + h.text).join('\n\n');
      const footer = `\n\n—\nThis summary contains general information only and is not a medical diagnosis. In an emergency call 000.`;
      const text = header + body + footer;
      navigator.clipboard.writeText(text).catch(() => {
        const ta = document.createElement('textarea');
        ta.value = text; ta.style.position='fixed'; ta.style.opacity='0';
        document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      });
    }

    function resetChat() {
      history.length = 0;
      // remove all rows except the welcome card (first element)
      const nodes = Array.from(chat.querySelectorAll('.row'));
      nodes.forEach(n => n.remove());
      msgInp.focus();
    }

    // Wire up
    send.addEventListener('click', () => sendMsg());
    msgInp.addEventListener('keydown', e => { if (e.key === 'Enter') sendMsg(); });
    copyBtn.addEventListener('click', copyForGP);
    resetBtn.addEventListener('click', resetChat);
  </script>
</body>
</html>
