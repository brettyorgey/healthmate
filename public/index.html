<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FifthQtr Healthmate</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --card-bg:#ffffff; --page-bg:#f7f9fc; --text:#0f172a; --muted:#4b5563; --brand:#0ea5e9; }
    body { margin:0; background:var(--page-bg); color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    .wrap { width:70%; max-width:1000px; min-width:320px; margin:24px auto; padding:0 16px; }

    .hero { background:var(--card-bg); border-radius:16px; padding:24px;
      box-shadow:0 4px 14px rgba(15,23,42,0.08); margin-bottom:12px; }
    .hero h1{ margin:0 0 8px; font-size:28px; line-height:1.2;}
    .hero p{ margin:6px 0 0; color:var(--muted);}

    .toolbar{ display:flex; gap:8px; justify-content:flex-end; margin-bottom:10px; }
    .btn-sm{ padding:8px 10px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; font-size:13px; }
    .btn-sm:hover{ background:#f9fafb; }

    .starters{ display:flex; flex-direction:column; gap:10px; margin:12px 0 16px; }
    .starter-btn{ display:block; text-align:left; border:1px solid #e5e7eb; background:#fff;
      border-radius:10px; padding:10px 12px; cursor:pointer; font-size:15px; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
    .starter-btn:hover{ background:#f9fafb; }

    .chat{ background:var(--card-bg); border-radius:16px; padding:16px;
      box-shadow:0 4px 14px rgba(15,23,42,0.08); min-height:280px; }
    .msg{ white-space:pre-wrap; margin:0 0 14px; }
    .msg.user{ background:#eff6ff; padding:10px 12px; border-radius:10px; }
    .msg.assistant{ background:#f8fafc; padding:10px 12px; border-radius:10px; }
    .msg.assistant h2,.msg.assistant h3{ margin:10px 0 6px; font-size:18px; line-height:1.25; border-left:4px solid var(--brand); padding-left:8px; }

    .sources{ margin-top:16px; padding:12px; border:1px solid #e5e7eb; border-radius:10px; background:#f9fafb; font-size:14px; line-height:1.5; }
    .sources strong{ display:block; margin-bottom:6px; font-size:15px; color:var(--text); }
    .sources ul{ margin:0; padding-left:18px; }
    .sources li{ margin-bottom:4px; }
    .sources a{ color:var(--brand); font-weight:500; text-decoration:underline; }
    .sources a:hover{ text-decoration:none; }
    .src-quote{ margin-top:4px; padding-left:10px; border-left:3px solid #e5e7eb; color:#475569; font-size:13px; font-style:italic; line-height:1.5; white-space:pre-wrap; }

    .inputRow{ display:flex; gap:10px; align-items:stretch; margin-top:12px;}
    textarea#msg{ flex:1; padding:14px 16px; font-size:16px; line-height:1.35; border-radius:12px; border:1px solid #e5e7eb; resize:vertical; min-height:72px; max-height:300px; }
    button.send{ padding:14px 18px; border-radius:12px; border:0; background:var(--brand); color:#fff; cursor:pointer; font-size:16px; font-weight:600; }
    button.send[disabled]{ opacity:.6; cursor:not-allowed; }

    /* Loading “Thinking…” bubble */
    .thinking{ display:inline-flex; gap:6px; align-items:center; color:#475569; }
    .dot{ width:6px; height:6px; border-radius:50%; background:#94a3b8; opacity:.6; animation:b 1.3s infinite ease-in-out; }
    .dot:nth-child(2){ animation-delay:.15s; } .dot:nth-child(3){ animation-delay:.3s; }
    @keyframes b { 0%,80%,100%{ transform:scale(0.7); opacity:.4; } 40%{ transform:scale(1); opacity:1; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>Welcome — we’re here to support past players & families.</h1>
      <p>Information only — not a medical diagnosis. Please see your GP for advice. In an emergency call 000.</p>
    </div>

    <div class="toolbar">
      <button class="btn-sm" id="copyBtn" title="Copy conversation to clipboard">Copy conversation</button>
      <button class="btn-sm" id="resetBtn" title="Clear chat">Reset chat</button>
    </div>

    <div class="starters" id="starters"></div>

    <div class="chat" id="chat"></div>

    <div class="inputRow">
      <textarea id="msg" rows="3" placeholder="Type your question…"></textarea>
      <button class="send" id="sendBtn" onclick="sendMsg()">Send</button>
    </div>
  </div>

  <script>
    // ---------- Starter prompts ----------
    const STARTER_PROMPTS = [
      { label:"My partner retired from footy 15 years ago and now gets headaches and forgets tasks — what should we do?",
        msg:"My partner retired from footy 15 years ago and now gets headaches and forgets tasks — what should we do?" },
      { label:"I’m a retired player with mood swings and poor sleep — where can I find support?",
        msg:"I’m a retired player with mood swings and poor sleep — where can I find support in Australia?" },
      { label:"I left football 10+ years ago — are there Australian clinics that check memory and thinking?",
        msg:"I left football 10+ years ago — are there Australian clinics that check memory and thinking?" },
      { label:"I’m caring for a former teammate with worsening headaches and anxiety — what help is available for partners/carers?",
        msg:"I’m caring for a former teammate with worsening headaches and anxiety — what help is available for partners/carers?" },
      { label:"What’s the difference between post-concussion symptoms and CTE, and where can I read reliable info?",
        msg:"What’s the difference between post-concussion symptoms and CTE, and where can I read reliable info?" }
    ];
    function renderStarters(){
      const box=document.getElementById('starters'); box.innerHTML='';
      STARTER_PROMPTS.forEach(p=>{
        const b=document.createElement('button'); b.className='starter-btn'; b.textContent=p.label;
        b.addEventListener('click',()=>sendMsg(p.msg)); box.appendChild(b);
      });
    }

    // ---------- Markdown + rendering helpers ----------
    function mdToHtml(md){
      if(!md) return '';
      let s=md;
      s=s.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>');
      s=s.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>');
      s=s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
      s=s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
      s=s.replace(/\n{2,}/g,'</p><p>').replace(/\n/g,'<br/>');
      return '<p>'+s+'</p>';
    }
    function trimQuote(q,max=280){ if(!q) return ''; const t=q.trim(); return t.length>max?t.slice(0,max)+'…':t; }

    // Keep a transcript for "Copy conversation"
    const TRANSCRIPT = []; // {role, text}

    function addMsg(role,text,sources){
      TRANSCRIPT.push({role, text: text || ''});
      const chat=document.getElementById('chat');
      const div=document.createElement('div'); div.className='msg '+role;
      if(role==='assistant'){
        div.innerHTML=mdToHtml(text||'');
        if(Array.isArray(sources)&&sources.length){
          const src=document.createElement('div'); src.className='sources';
          let html='<strong>Sources</strong><ul>';
          for(const s of sources){
            const href=`/api/file?file_id=${encodeURIComponent(s.file_id)}`;
            html+=`<li>
              <a href="${href}" target="_blank" rel="noopener">${s.filename || s.file_id}</a>
              ${s.quote && s.quote.trim()?`<div class="src-quote">“${trimQuote(s.quote)}”</div>`:''}
            </li>`;
          }
          html+='</ul>'; src.innerHTML=html; div.appendChild(src);
        }
      } else {
        div.textContent=text;
      }
      chat.appendChild(div);
      chat.scrollTop=chat.scrollHeight;
      return div;
    }

    // ---------- Loading indicator ----------
    function showThinking(){
      const div=addMsg('assistant',''); // placeholder
      div.innerHTML = '<span class="thinking" aria-live="polite" aria-label="Assistant is thinking"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Thinking…</span>';
      return div;
    }

    // ---------- Copy / Reset ----------
    async function copyConversation(){
      if(!navigator.clipboard){ alert('Clipboard not available'); return; }
      const text = TRANSCRIPT.map(m=>`${m.role.toUpperCase()}: ${m.text}`).join('\n\n');
      await navigator.clipboard.writeText(text || '(empty)');
      const btn=document.getElementById('copyBtn'); const old=btn.textContent;
      btn.textContent='Copied ✓'; setTimeout(()=>btn.textContent=old,1200);
    }
    function resetChat(){
      TRANSCRIPT.splice(0,TRANSCRIPT.length);
      document.getElementById('chat').innerHTML='';
    }

    // ---------- Send message ----------
    async function sendMsg(txt){
      const inp=document.getElementById('msg');
      const content=(txt || inp.value || '').trim(); if(!content) return;
      addMsg('user',content);
      inp.value=''; document.getElementById('sendBtn').disabled=true;
      const thinkingEl = showThinking();
      try{
        const r=await fetch('/api/mascot',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message:content}) });
        const data=await r.json().catch(()=>({}));
        thinkingEl.remove();
        if (!r.ok) {
        if (r.status === 504) {
          addMsg('assistant', 'Sorry — the assistant is taking longer than usual. Please try again, or rephrase your question more specifically.');
        } else {
        const detail = typeof data?.detail === 'string' ? ` (${data.detail})` : '';
        addMsg('assistant', 'Sorry — server error' + detail);
        }
        } else {
          addMsg('assistant', data.output || 'No response', data.sources);
        }
      }catch(e){
        thinkingEl.remove();
        addMsg('assistant','Sorry — network error.');
      }finally{
        document.getElementById('sendBtn').disabled=false;
      }
    }

    // Init
    document.getElementById('copyBtn').addEventListener('click', copyConversation);
    document.getElementById('resetBtn').addEventListener('click', resetChat);
    document.addEventListener('DOMContentLoaded', renderStarters);
  </script>
</body>
</html>
